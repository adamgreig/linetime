#include "ch.h"
#include "hal.h"

#include "speaker.h"

/*
 * DAC test buffer (sine wave).
 */
#define DAC_BUFFER_SIZE 360
static const dacsample_t dac_buffer[DAC_BUFFER_SIZE] = {
    2048, 2065, 2083, 2101, 2119, 2137, 2155, 2172, 2190, 2208, 2225, 2243,
    2260, 2278, 2295, 2313, 2330, 2347, 2364, 2381, 2398, 2414, 2431, 2448,
    2464, 2480, 2496, 2512, 2528, 2544, 2560, 2575, 2590, 2605, 2620, 2635,
    2649, 2664, 2678, 2692, 2706, 2719, 2733, 2746, 2759, 2772, 2784, 2796,
    2808, 2820, 2832, 2843, 2854, 2865, 2876, 2886, 2896, 2906, 2916, 2925,
    2934, 2943, 2952, 2960, 2968, 2976, 2983, 2990, 2997, 3003, 3010, 3016,
    3021, 3027, 3032, 3037, 3041, 3045, 3049, 3053, 3056, 3059, 3062, 3064,
    3066, 3068, 3069, 3070, 3071, 3071, 3072, 3071, 3071, 3070, 3069, 3068,
    3066, 3064, 3062, 3059, 3056, 3053, 3049, 3045, 3041, 3037, 3032, 3027,
    3021, 3016, 3010, 3003, 2997, 2990, 2983, 2976, 2968, 2960, 2952, 2943,
    2934, 2925, 2916, 2906, 2896, 2886, 2876, 2865, 2854, 2843, 2832, 2820,
    2808, 2796, 2784, 2772, 2759, 2746, 2733, 2719, 2706, 2692, 2678, 2664,
    2649, 2635, 2620, 2605, 2590, 2575, 2560, 2544, 2528, 2512, 2496, 2480,
    2464, 2448, 2431, 2414, 2398, 2381, 2364, 2347, 2330, 2313, 2295, 2278,
    2260, 2243, 2225, 2208, 2190, 2172, 2155, 2137, 2119, 2101, 2083, 2065,
    2048, 2030, 2012, 1994, 1976, 1958, 1940, 1923, 1905, 1887, 1870, 1852,
    1835, 1817, 1800, 1782, 1765, 1748, 1731, 1714, 1697, 1681, 1664, 1647,
    1631, 1615, 1599, 1583, 1567, 1551, 1536, 1520, 1505, 1490, 1475, 1460,
    1446, 1431, 1417, 1403, 1389, 1376, 1362, 1349, 1336, 1323, 1311, 1299,
    1287, 1275, 1263, 1252, 1241, 1230, 1219, 1209, 1199, 1189, 1179, 1170,
    1161, 1152, 1143, 1135, 1127, 1119, 1112, 1105, 1098, 1092, 1085, 1079,
    1074, 1068, 1063, 1058, 1054, 1050, 1046, 1042, 1039, 1036, 1033, 1031,
    1029, 1027, 1026, 1025, 1024, 1024, 1024, 1024, 1024, 1025, 1026, 1027,
    1029, 1031, 1033, 1036, 1039, 1042, 1046, 1050, 1054, 1058, 1063, 1068,
    1074, 1079, 1085, 1092, 1098, 1105, 1112, 1119, 1127, 1135, 1143, 1152,
    1161, 1170, 1179, 1189, 1199, 1209, 1219, 1230, 1241, 1252, 1263, 1275,
    1287, 1299, 1311, 1323, 1336, 1349, 1362, 1376, 1389, 1403, 1417, 1431,
    1446, 1460, 1475, 1490, 1505, 1520, 1535, 1551, 1567, 1583, 1599, 1615,
    1631, 1647, 1664, 1681, 1697, 1714, 1731, 1748, 1765, 1782, 1800, 1817,
    1835, 1852, 1870, 1887, 1905, 1923, 1940, 1958, 1976, 1994, 2012, 2030,
};

static uint32_t play_count;
static uint32_t play_limit;
static void end_cb(DACDriver *dacp, const dacsample_t *buffer, size_t n) {
    (void)dacp; (void)buffer; (void)n;
    play_count++;
    if(play_count >= play_limit && DACD2.state == DAC_ACTIVE) {
        chSysLockFromISR();
        dacStopConversionI(&DACD2);
        gptStopTimerI(&GPTD6);
        chSysUnlockFromISR();
    }
}

static const DACConfig dac_cfg = {
    .init = 2047,
    .datamode = DAC_DHRM_12BIT_RIGHT,
};

static const DACConversionGroup dac_grp_cfg = {
    .num_channels = 1,
    .end_cb = end_cb,
    .error_cb = NULL,
    .trigger = DAC_TRG(0),
};

static const GPTConfig gpt_cfg = {
    .frequency = 10000000,
    .callback = NULL,
    .cr2 = TIM_CR2_MMS_1,
    .dier = 0,
};

void speaker_beep(uint32_t duration_ms)
{
    play_count = 0;
    play_limit = duration_ms;

    if(DACD2.state == DAC_ACTIVE) {
        dacStopConversion(&DACD2);
        gptStopTimer(&GPTD6);
    }

    dacStartConversion(&DACD2, &dac_grp_cfg, dac_buffer, DAC_BUFFER_SIZE);
    gptStartContinuous(&GPTD6, 28);
}

void speaker_init()
{
    gptStart(&GPTD6, &gpt_cfg);
    dacStart(&DACD2, &dac_cfg);
}

void speaker_on()
{
    palSetLine(LINE_SOUNDER_SD);
}

void speaker_off()
{
    palClearLine(LINE_SOUNDER_SD);
}
